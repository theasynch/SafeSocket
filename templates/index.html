<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* --- DARK THEME STYLING --- */
body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    background-color: #1a1a2e; 
    color: white; 
    text-align: center; 
    margin: 0; 
    padding: 20px; 
}
.container { max-width: 900px; margin: auto; }

/* Layout */
.dashboard-grid { 
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 20px; 
    margin-bottom: 20px; 
}

.card { 
    background: #16213e; 
    padding: 25px; 
    border-radius: 15px; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
    border: 1px solid #0f3460;
}

.full-width { grid-column: span 2; }

/* Typography */
h1 { color: #e94560; margin-bottom: 5px; }
.subtitle { color: #8d99ae; font-size: 0.9em; margin-bottom: 30px; }
.label { color: #a5a5a5; display: block; margin-bottom: 5px; font-size: 1.1em; }
.value { font-size: 3rem; font-weight: 800; color: #fff; }

/* Status Badges */
.status-box { 
    padding: 10px 20px; 
    border-radius: 50px; 
    font-weight: bold; 
    font-size: 1.2rem;
    transition: all 0.3s ease;
    text-transform: uppercase;
}

.safe { background: #2ecc71; color: white; box-shadow: 0 0 10px rgba(46, 204, 113, 0.4); }
.warning { background: #f1c40f; color: black; animation: pulse 1s infinite; }
.cutoff { background: #e74c3c; color: white; animation: flash 0.5s infinite; }

@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
@keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

/* Chart Canvas */
canvas { max-height: 350px; width: 100%; }

/* --- NOTIFICATION STYLES (NEW) --- */
#notification-area {
    position: fixed;
    top: 10px;
    right: 10px;
    z-index: 1000;
    width: 300px;
}
.notification {
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 8px;
    text-align: left;
    box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    transition: opacity 0.5s ease-out, transform 0.5s ease-out;
    opacity: 0;
    transform: translateX(100%);
}
.notification.show {
    opacity: 1;
    transform: translateX(0);
}
.notification.info { background-color: #3498db; }
.notification.danger { background-color: #e74c3c; font-weight: bold; }
.notification.success { background-color: #2ecc71; }
    </style>
    <title>SafeSocket Analytics</title>
    <!-- Import Chart.js Library for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <div class="container">
        <h1>âš¡ SafeSocket Analytics</h1>
        <p class="subtitle">IoT Fire Prevention & Power Monitoring System</p>

        <!-- LIVE DATA ROW -->
        <div class="dashboard-grid">
            <!-- Current Card -->
            <div class="card">
                <span class="label">Live Load</span>
                <div id="amps" class="value">0.00 A</div>
            </div>

            <!-- Status Card -->
            <div class="card">
                <span class="label">Safety Status</span>
                <div style="margin-top: 10px;">
                    <span id="status" class="status-box safe">CONNECTING...</span>
                </div>
                <p style="margin-top: 15px; color: #666; font-size: 0.8em;">Last Update: <span id="time">--:--:--</span></p>
            </div>
        </div>

        <!-- GRAPH ROW -->
        <div class="card full-width">
            <h3 style="color: #a5a5a5; margin-top: 0;">Real-Time Power Consumption (Watts)</h3>
            <canvas id="powerChart"></canvas>
        </div>
    </div>

    <!-- FLOATING NOTIFICATION AREA (NEW) -->
    <div id="notification-area"></div>

    <script>
        // --- 1. SETUP THE CHART ---
        const ctx = document.getElementById('powerChart').getContext('2d');
        const powerChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [], 
                datasets: [{
                    label: 'Power (Watts)',
                    data: [], 
                    borderColor: '#e94560',
                    backgroundColor: 'rgba(233, 69, 96, 0.2)',
                    borderWidth: 3,
                    pointRadius: 2,
                    fill: true,
                    tension: 0.4 
                }]
            },
            options: {
                responsive: true,
                interaction: { intersect: false, mode: 'index' },
                scales: {
                    x: { ticks: { color: '#a5a5a5' }, grid: { color: '#1f2041' } },
                    y: { ticks: { color: '#a5a5a5' }, grid: { color: '#1f2041' }, beginAtZero: true }
                },
                plugins: { legend: { labels: { color: 'white' } } }
            }
        });

        // --- 2. NOTIFICATION HANDLER (NEW) ---
        function showNotification(type, message) {
            const area = document.getElementById('notification-area');
            const note = document.createElement('div');
            note.className = `notification ${type}`;
            note.innerHTML = `<strong>${type.toUpperCase()}</strong>: ${message}`;
            
            area.prepend(note); // Add to the top
            
            // Trigger animation
            setTimeout(() => { note.classList.add('show'); }, 10); 

            // Auto-hide after 5 seconds
            setTimeout(() => {
                note.style.opacity = '0';
                note.style.transform = 'translateX(100%)';
                // Remove element after transition finishes
                note.addEventListener('transitionend', () => note.remove());
            }, 5000); 
        }

        // --- 3. FETCH DATA LOOP ---
        function updateDashboard() {
            // A. Get Live Status & Notifications
            fetch('/get_live_data')
                .then(res => res.json())
                .then(response => {
                    const data = response.live_data;
                    const notifications = response.notifications;

                    // 1. Process Live Data
                    document.getElementById('amps').innerText = data.current + " A";
                    document.getElementById('time').innerText = data.timestamp;
                    
                    const statusBox = document.getElementById('status');
                    statusBox.innerText = data.status;
                    
                    statusBox.className = "status-box"; 
                    if (data.status.includes("WARNING")) {
                        statusBox.classList.add("warning");
                    } else if (data.status.includes("CUTOFF")) {
                        statusBox.classList.add("cutoff");
                    } else {
                        statusBox.classList.add("safe");
                    }
                    
                    // 2. Display Notifications (NEW)
                    if (notifications.length > 0) {
                        notifications.forEach(n => {
                            showNotification(n.type, n.message);
                        });
                    }
                })
                .catch(err => console.error("Server Disconnected"));

            // B. Get Graph History
            fetch('/get_history')
                .then(res => res.json())
                .then(data => {
                    if(data.labels && data.power) {
                        powerChart.data.labels = data.labels;
                        powerChart.data.datasets[0].data = data.power;
                        powerChart.update('none'); 
                    }
                });
        }

        // Refresh Data Every 1 Second
        setInterval(updateDashboard, 1000);
    </script>
</body>
</html>